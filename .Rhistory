n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("for_veit/H9_MCM_complex_for_vsclust.csv")
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(H9_MCM_complex,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
# MCM4 + MCM5 -> "incorrect number of dimensions". Error not always produced by MCM4
# MCM7 -> "Principal component analysis not shown as too many missing values"
# MCM7 -> "Principal component analysis not shown as too many missing values"
H9_MCM_complex
names(H9_MCM_complex)
MCM6 <- H9_MCM_complex[H9_B1_D100["protein"] == "MCM6", ]
MCM6
names(H9_MCM_complex)
MCM6 <- H9_MCM_complex[H9_B1_D100["Gene name"] == "MCM6", ]
MCM6
H9_MCM_complex$`Gene name`
MCM6 <- H9_MCM_complex[H9_B1_D100[["Gene name"]] == "MCM6", ]
MCM6 <- H9_MCM_complex[H9_B1_D100$"Gene name" == "MCM6", ]
MCM6 <- H9_MCM_complex[H9_MCM_complex$`Gene name` == "MCM6", ]
MCM6
View(MCM6)
# Return all results
invisible(list(
results = all_results,
skipped_genes = skip ped_genes,
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
library(data.table)
library(vsclust)
library(parallel)
####################
#
prepare_for_vsclust <- function(data,
n_rep = 3,
n_cond = 5,
id_cols = NULL,
measurement_cols = NULL){
# Sanity check
if (is.null(id_cols) || is.null(measurement_cols)) {
stop("id_cols and measurement_cols must be provided")
}
if (length(measurement_cols) != n_rep * n_cond) {
stop("amount of measurement columns must equal n_rep * n_cond")
}
# Convert id_cols to unique row identifiers
row_ids <- apply(data[, id_cols, with = FALSE], 1, function(row) paste(row, collapse = "_"))
row_ids <- make.unique(row_ids)
# Extract measurement data
measurement_data <- data[, measurement_cols, with = FALSE]
# Combine row_ids with measurement data
prepared_data <- cbind(Identifier = row_ids, measurement_data)
return(prepared_data)
}
######################
# Function to reorder and further prepare data for performing vsclust:
# Reorders columns from condition-grouped to replicate-grouped
# Converts to data.frame and create row names from id_cols to backtrack
reorder_for_vsclust <- function(data,
n_rep = 3,
n_cond = 5,
id_col = "Identifier",
reorder = TRUE) {
# Sanity check
if (!(id_col %in% names(data))) {
stop(paste("id_col", id_col, "not found in data"))
}
# Save row identifiers
row_ids <- data[[id_col]]
data <- data[, -..id_col]
# Check dimensions
if (n_rep * n_cond != ncol(data)) {
stop("Number of columns in data does not match n_rep * n_cond")
}
if (reorder){
# Create index matrix (conditions Ã— replicates)
idx_matrix <- matrix(seq_len(n_rep * n_cond),
nrow = n_cond,
ncol = n_rep,
byrow = TRUE)
# Transpose and flatten to get new column order
new_order <- as.vector(idx_matrix)
# Return reordered data.table
data <- data[, ..new_order]
}
# Convert to data.frame for vsclust
data <- as.data.frame(data)
# Restore row names
row.names(data) <- row_ids
return(data)
}
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
tryCatch({
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
tryCatch({
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM6,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
H9_MCM_complex
MCM_clustering <- vsclust_on_proteoform_short(H9_MCM_complex,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
MCM7 <- H9_MCM_complex[H9_MCM_complex$`Gene name` == "MCM7", ]
View(MCM7)
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
traceback()

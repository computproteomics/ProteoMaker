######################
# Function to reorder and further prepare data for performing vsclust:
# Reorders columns from condition-grouped to replicate-grouped
# Converts to data.frame and create row names from id_cols to backtrack
reorder_for_vsclust <- function(data,
n_rep = 3,
n_cond = 5,
id_col = "Identifier",
reorder = TRUE) {
# Sanity check
if (!(id_col %in% names(data))) {
stop(paste("id_col", id_col, "not found in data"))
}
# Save row identifiers
row_ids <- data[[id_col]]
data <- data[, -..id_col]
# Check dimensions
if (n_rep * n_cond != ncol(data)) {
stop("Number of columns in data does not match n_rep * n_cond")
}
if (reorder){
# Create index matrix (conditions Ã— replicates)
idx_matrix <- matrix(seq_len(n_rep * n_cond),
nrow = n_cond,
ncol = n_rep,
byrow = TRUE)
# Transpose and flatten to get new column order
new_order <- as.vector(idx_matrix)
# Return reordered data.table
data <- data[, ..new_order]
}
# Convert to data.frame for vsclust
data <- as.data.frame(data)
# Restore row names
row.names(data) <- row_ids
return(data)
}
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
tryCatch({
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
tryCatch({
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM6,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
H9_MCM_complex
MCM_clustering <- vsclust_on_proteoform_short(H9_MCM_complex,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
MCM7 <- H9_MCM_complex[H9_MCM_complex$`Gene name` == "MCM7", ]
View(MCM7)
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
traceback()
library(ProteoMaker)
#####################
## Paths and directories
#####################
proteomaker <- set_proteomaker(fastaFilePath =
system.file("Proteomes",
package = "ProteoMaker"),
resultFilePath = "SimulatedDataSets",
cores = 2, clusterType = "PSOCK",
runStatTests = TRUE,
calcAllBenchmarks = TRUE
)
#####################
## Create default list of testing parameters
#####################
# Param <- def_param("tmp/parameters.yml")
Param <- def_param()
Param$paramGroundTruth$NumReps <- c(5)
# Param$paramDigest$EnrichmentEfficiency <- 0.8
# Param$paramDigest$ModificationLoss <- 0.5
# Param$paramMSRun$PercDetectedVal <- 0.5
Param$paramMSRun$MSNoise <- 1
Param$paramDataAnalysis$ProtSummarization <- "median"
Param$paramGroundTruth$ModifiableResidues <-
list(m1 = list(ph=c("S", "T", "Y"), ox = c("M", "K")))
Param$paramGroundTruth$ModifiableResiduesDistr <-
list(m1 = list(ph=c(0.86, 0.13, 0.01), ox = c(0.5, 0.5)))
Param$paramDigest$EnrichPTM <- "ph"
Param$paramGroundTruth$FracModProt <- 0.5
shiny::runApp('inst/shiny')
ox_proteo <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_ProteoformAb.csv")
noox_proteo <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_ProteoformAb.csv")
plot(sort(ox_proteo$C_1_R_1), sort(noox_proteo$C_1_R_1))
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
ox_msrun <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_MSRun_NonEnriched.csv")
noox_msrun <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_MSRun_NonEnriched.csv")
plot(sort(ox_msrun$C_1_R_1), type="l")
lines(sort(noox_msrun$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100)
hist(noox_proteo$C_1_R_1, breaks=100, add=T)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
View(ox_msrun)
View(ox_proteo)
View(ox_proteo)
devtools::load_all()
runApp('inst/shiny')
runApp('inst/shiny')
devtools::load_all()
runApp('inst/shiny')
ox_proteo <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_ProteoformAb.csv")
noox_proteo <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_ProteoformAb.csv")
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
ox_msrun <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_MSRun_NonEnriched.csv")
noox_msrun <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_MSRun_NonEnriched.csv")
plot(sort(ox_msrun$C_1_R_1), type="l")
lines(sort(noox_msrun$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
source("~/.active-rstudio-document", echo = TRUE)

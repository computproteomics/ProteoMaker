cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
tryCatch({
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}, error = function(e) {
message(paste("ERROR processing", gene, ":", e$message))
skipped_genes <<- c(skipped_genes, gene)
})
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM6,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
H9_MCM_complex
MCM_clustering <- vsclust_on_proteoform_short(H9_MCM_complex,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
MCM7 <- H9_MCM_complex[H9_MCM_complex$`Gene name` == "MCM7", ]
View(MCM7)
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
######################
# Function to run vsclust on individual proteoforms (per gene)
vsclust_on_proteoform_short <- function(data,
id_cols,
value_cols,
gene_col = "Gene name",
n_rep = 3,
n_cond = NULL,
n_clusters = NULL,
min_features = 3,
grouped_replicates = TRUE){
# Sanity checks
if (!requireNamespace("vsclust", quietly = TRUE)) {
stop("Package 'VSClust' is required. Install with: BiocManager::install('VSClust')")
}
if (!(gene_col %in% names(data))) {
stop(paste("gene_col", gene_col, "not found in data"))
}
if (is.null(n_cond)) {
n_cond <- length(value_cols) / n_rep
}
if (length(value_cols) != n_cond * n_rep) {
stop("Length of value_cols must equal n_cond * n_rep")
}
# Load required libraries
require(data.table, quietly = TRUE)
require(vsclust, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(tidyr, quietly = TRUE)
require(matrixStats, quietly = TRUE)
require(ComplexHeatmap, quietly = TRUE)
require(parallel, quietly = TRUE)
# Get unique genes
unique_genes <- unique(data[[gene_col]])
unique_genes <- unique_genes[!is.na(unique_genes) & unique_genes != ""]
message(paste("Found", length(unique_genes), "unique genes"))
# Preprocess data
data <- prepare_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_cols = id_cols,
measurement_cols = value_cols)
data <- reorder_for_vsclust(data,
n_rep = n_rep,
n_cond = n_cond,
id_col = "Identifier",
reorder = grouped_replicates)
# Initialize results list
all_results <- list()
skipped_genes <- character()
# Process each gene
for (gene in unique_genes) {
# Subset data for this gene
gene_data <- data[grepl(paste0("*", gene, "_*"), rownames(data)), ]
# Check if enough featrures
if (nrow(gene_data) < min_features) {
skipped_genes <- c(skipped_genes, gene)
message(paste("Skipping", gene, "- only", nrow(gene_data), "feature(s) (min:", min_features, ")"))
next
}
message(paste("\n=== Processing", gene, "(", nrow(gene_data), "features ) ==="))
dat <- gene_data
# Prepare data for vsclust
message("Preparing data for vsclust...")
# Set parameters for vsclust
PreSetNumClustVSClust <- ifelse(is.null(n_clusters), 0, n_clusters)
maxClust <- min(15, nrow(dat) - 1)  # Can't have more clusters than proteoforms
cores <- parallel::detectCores() - 2
# Run pre-clustering analysis
message("Running pre-clustering analysis...")
suppressWarnings(
statOut <- PrepareForVSClust(dat, n_rep, n_cond, isPaired = FALSE, TRUE)
)
dat <- statOut$dat
# Report basic statistics
Sds <- dat[, ncol(dat)]
cat(paste("Features:", nrow(dat),
"\nMissing values:", sum(is.na(dat)),
"\nMedian standard deviations:", round(median(Sds, na.rm = TRUE), digits = 3), "\n"))
# Estimate number of clusters
message("Estimating number of clusters...")
print(head(dat))
ClustInd <- estimClustNum(dat,
maxClust = maxClust,
scaling = "standardize",
cores = cores)
if (PreSetNumClustVSClust == 0) {
PreSetNumClustVSClust <- optimalClustNum(ClustInd, index = "XieBeni", method = "VSClust")
message("Estimated number of clusters: ", PreSetNumClustVSClust)
}
# Run clustering
message("Running clustering...")
ClustOut <- runClustWrapper(dat,
NClust = PreSetNumClustVSClust,
proteins = NULL,
VSClust = TRUE,
scaling = "standardize",
cores = cores)
message("Clustering completed for ", gene)
}
# Summary
message("\n=== Summary ===")
message(paste("Total genes processed:", length(all_results)))
message(paste("Genes skipped:", length(skipped_genes)))
if (length(skipped_genes) > 0) {
message(paste("Skipped genes:", paste(skipped_genes, collapse = ", ")))
}
# Return all results
invisible(list(
results = all_results,
skipped_genes = skipped_genes,
n_genes_processed = length(all_results),
n_genes_skipped = length(skipped_genes)
))
}
######################
H9_MCM_complex <- fread("H9_MCM_complex_for_vsclust.csv")
MCM_clustering <- vsclust_on_proteoform_short(MCM7,
id_cols = c("Accession", "Gene name", "Position in master protein",
"Modifications in master protein", "datatype"),
value_cols = grep("^H9", names(H9_MCM_complex), value = TRUE),
n_rep = 3,
n_cond = 28,
n_clusters = NULL,
grouped_replicates = TRUE
)
traceback()
library(ProteoMaker)
#####################
## Paths and directories
#####################
proteomaker <- set_proteomaker(fastaFilePath =
system.file("Proteomes",
package = "ProteoMaker"),
resultFilePath = "SimulatedDataSets",
cores = 2, clusterType = "PSOCK",
runStatTests = TRUE,
calcAllBenchmarks = TRUE
)
#####################
## Create default list of testing parameters
#####################
# Param <- def_param("tmp/parameters.yml")
Param <- def_param()
Param$paramGroundTruth$NumReps <- c(5)
# Param$paramDigest$EnrichmentEfficiency <- 0.8
# Param$paramDigest$ModificationLoss <- 0.5
# Param$paramMSRun$PercDetectedVal <- 0.5
Param$paramMSRun$MSNoise <- 1
Param$paramDataAnalysis$ProtSummarization <- "median"
Param$paramGroundTruth$ModifiableResidues <-
list(m1 = list(ph=c("S", "T", "Y"), ox = c("M", "K")))
Param$paramGroundTruth$ModifiableResiduesDistr <-
list(m1 = list(ph=c(0.86, 0.13, 0.01), ox = c(0.5, 0.5)))
Param$paramDigest$EnrichPTM <- "ph"
Param$paramGroundTruth$FracModProt <- 0.5
shiny::runApp('inst/shiny')
ox_proteo <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_ProteoformAb.csv")
noox_proteo <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_ProteoformAb.csv")
plot(sort(ox_proteo$C_1_R_1), sort(noox_proteo$C_1_R_1))
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
ox_msrun <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_MSRun_NonEnriched.csv")
noox_msrun <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_MSRun_NonEnriched.csv")
plot(sort(ox_msrun$C_1_R_1), type="l")
lines(sort(noox_msrun$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100)
hist(noox_proteo$C_1_R_1, breaks=100, add=T)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
View(ox_msrun)
View(ox_proteo)
View(ox_proteo)
devtools::load_all()
runApp('inst/shiny')
runApp('inst/shiny')
devtools::load_all()
runApp('inst/shiny')
ox_proteo <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_ProteoformAb.csv")
noox_proteo <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_ProteoformAb.csv")
plot(sort(ox_proteo$C_1_R_1), type="l")
lines(sort(noox_proteo$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
ox_msrun <- read.csv("/data/tmp/ProteoMaker/0.5/ProteoMaker_results_MSRun_NonEnriched.csv")
noox_msrun <- read.csv("/data/tmp/ProteoMaker/0.0/ProteoMaker_results_MSRun_NonEnriched.csv")
plot(sort(ox_msrun$C_1_R_1), type="l")
lines(sort(noox_msrun$C_1_R_1), col=2)
hist(ox_proteo$C_1_R_1, breaks=100, col="#3333AA77")
hist(noox_proteo$C_1_R_1, breaks=100, add=T, col = "#AA333377")
source("~/.active-rstudio-document", echo = TRUE)
setwd("~/devel/Bioinformatics/EuBIC/ProteoMakerEval")
library(GGally)
library(lattice)
library(ProteoMaker)
library(ggplot2)
library(viridis)
library(dplyr)
library(tidyr)
library(hexbin)
library(gplots)
library(ggridges)
# get benchmarks
simvars <- list(test = list(simvar="WrongIDs", filter = NULL, metrics = 1:45),
WrongIDs_Multi = list(simvar="WrongIDs", filter = NULL, metrics =  c(2, 18, 22, 24)),
DiffReg_New = list(simvar=c("DiffRegFrac", "DiffRegMax"), filter = "DiffRegFrac==0.2", metrics = 1:45),
MisCleav_Multi = list(simvar="PropMissedCleavages", filter = "PepMaxLength==30", metrics = c(1:3, 11, 13, 17, 18, 21)),
MisCleav_PepLength_New = list(simvar=c("PropMissedCleavages","PepMaxLength"), filter = NULL, metrics = c(1:3, 11, 18, 21)),
SeqLength = list(simvar="PepMaxLength", filter = NULL, metrics = 1:45),
NumReps_New = list(simvar="NumReps", filter = NULL, metrics = c(1:2, 5, 6:7, 13:14, 18, 22:23, 28:29)),
NumReps_Multi = list(simvar="NumReps", filter = NULL, metrics = c(1:2, 5, 6:7, 13:14, 18, 22:23, 28:29)),
ExpressedProt = list(simvar="PercExpressedProt", filter = NULL, metrics = 1:45),
WrongIDs = list(simvar="WrongIDs", filter = NULL, metrics = c(2, 18, 22, 24)),
UniquePeps_Shared_Big_LargerDiff = list(simvar=c("MinUniquePep", "SharedPep"), filter = NULL, metrics = c(18, 21, 22, 23, 26, 27, 29, 30)),
UniquePeps_Shared_Multi = list(simvar=c("MinUniquePep", "SharedPep"), filter = "SharedPep!=FALSE", metrics = c(18, 19, 21, 22, 23, 26, 27, 30)),
PercExpressedProt_PercDetectability_New = list(simvar=c("PercExpressedProt", "PercDetectability"), filter = NULL, metrics = 1:45),
OxWithoutEnrichment_PercExpressedProt_New = list(simvar=c("FracModProt","PercExpressedProt"), filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36)),
OxWithoutEnrichment_multi = list(simvar="FracModProt", filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36)),
OxWithoutEnrichment = list(simvar="FracModProt", filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36))
)
fileext <- "OxWithoutEnrichment"
usecase <- simvars[[fileext]]
simvar <- unlist(usecase["simvar"])
fileext <- "WrongIDs_Multi"
usecase <- simvars[[fileext]]
simvar <- unlist(usecase["simvar"])
benchs <- read.csv(paste0("allBenchmarks_", fileext, ".csv"))
if (!is.null(usecase["filter"])) {
sel <- eval(parse(text=paste0("benchs$", usecase["filter"])))
benchs <- benchs[sel, ]
}
# get all figs
if (length(simvar) == 2)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = c(simvar[1], simvar[2]), errorbar = F)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = simvar[1], errorbar = F)
# Specific metrics for use case
ProteoMaker::visualize_benchmarks(benchs, unlist(usecase["metrics"]), ref_par = simvar[1], errorbar = T)
runs <- benchs$X[1:5]
# Retrieve runs from the server
pre_location <- "protprotocols.bmb.srv.sdu.dk:~/ProteoMaker/SimulatedDataSets/outputDataAnalysis_"
for (run in runs) {
if (!file.exists(paste0("tmp/outputDataAnalysis_", run, ".RData"))) {
system(paste0("scp ", pre_location, run, ".RData tmp/"))
} else {
print(paste0("File for run ", run, " already exists locally."))
}
}
setwd("~/devel/Bioinformatics/EuBIC/ProteoMakerEval")
library(GGally)
library(lattice)
library(ProteoMaker)
library(ggplot2)
library(viridis)
library(dplyr)
library(tidyr)
library(hexbin)
library(gplots)
library(GGally)
library(lattice)
library(ProteoMaker)
library(ggplot2)
library(viridis)
library(dplyr)
library(tidyr)
library(hexbin)
library(gplots)
library(ggridges)
# get benchmarks
simvars <- list(test = list(simvar="WrongIDs", filter = NULL, metrics = 1:45),
WrongIDs_Multi = list(simvar="WrongIDs", filter = NULL, metrics =  c(2, 18, 22, 24)),
DiffReg_New = list(simvar=c("DiffRegFrac", "DiffRegMax"), filter = "DiffRegFrac==0.2", metrics = 1:45),
MisCleav_Multi = list(simvar="PropMissedCleavages", filter = "PepMaxLength==30", metrics = c(1:3, 11, 13, 17, 18, 21)),
MisCleav_PepLength_New = list(simvar=c("PropMissedCleavages","PepMaxLength"), filter = NULL, metrics = c(1:3, 11, 18, 21)),
SeqLength = list(simvar="PepMaxLength", filter = NULL, metrics = 1:45),
NumReps_New = list(simvar="NumReps", filter = NULL, metrics = c(1:2, 5, 6:7, 13:14, 18, 22:23, 28:29)),
NumReps_Multi = list(simvar="NumReps", filter = NULL, metrics = c(1:2, 5, 6:7, 13:14, 18, 22:23, 28:29)),
ExpressedProt = list(simvar="PercExpressedProt", filter = NULL, metrics = 1:45),
WrongIDs = list(simvar="WrongIDs", filter = NULL, metrics = c(2, 18, 22, 24)),
UniquePeps_Shared_Big_LargerDiff = list(simvar=c("MinUniquePep", "SharedPep"), filter = NULL, metrics = c(18, 21, 22, 23, 26, 27, 29, 30)),
UniquePeps_Shared_Multi = list(simvar=c("MinUniquePep", "SharedPep"), filter = "SharedPep!=FALSE", metrics = c(18, 19, 21, 22, 23, 26, 27, 30)),
PercExpressedProt_PercDetectability_New = list(simvar=c("PercExpressedProt", "PercDetectability"), filter = NULL, metrics = 1:45),
OxWithoutEnrichment_PercExpressedProt_New = list(simvar=c("FracModProt","PercExpressedProt"), filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36)),
OxWithoutEnrichment_multi = list(simvar="FracModProt", filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36)),
PhOxWithoutEnrichment_multi = list(simvar="FracModProt", filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36)),
OxWithoutEnrichment = list(simvar="FracModProt", filter = NULL, metrics = c(1:3, 12, 13, 18, 21, 22, 23, 25, 27, 33, 36))
)
fileext <- "WrongIDs_Multi"
usecase <- simvars[[fileext]]
simvar <- unlist(usecase["simvar"])
benchs <- read.csv(paste0("allBenchmarks_", fileext, ".csv"))
if (!is.null(usecase["filter"])) {
sel <- eval(parse(text=paste0("benchs$", usecase["filter"])))
benchs <- benchs[sel, ]
}
# get all figs
if (length(simvar) == 2)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = c(simvar[1], simvar[2]), errorbar = F)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = simvar[1], errorbar = F)
# Specific metrics for use case
ProteoMaker::visualize_benchmarks(benchs, unlist(usecase["metrics"]), ref_par = simvar[1], errorbar = T)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = simvar[1], errorbar = F)
ProteoMaker::visualize_benchmarks(benchs, 1:45, ref_par = simvar[1], errorbar = T)
shiny::runApp('/data/tmp/BOB')
setwd("/data/tmp/BOB")
readRDS("data/CBO/Deglyco.rds")
runApp('/data/tmp/BOB-main')
shiny::runApp('inst/shiny')
devtools::load_all()
shiny::runApp('inst/shiny')
devtools::load_all()
shiny::runApp('inst/shiny')
runApp('inst/shiny')
shiny::runApp('inst/shiny')
